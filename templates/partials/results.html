<!-- Chat-style results partial - swapped in by HTMX -->

<!-- Header with Home link -->
<header class="bg-white border-b border-slate-200">
    <div class="max-w-5xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <a href="/" class="text-xl font-bold text-slate-900 tracking-tight">
                EconStats
            </a>
            <a href="/" class="text-sm text-primary-600 hover:underline flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                Home
            </a>
        </div>
    </div>
</header>

<!-- Main content -->
<main id="main-content" class="max-w-5xl mx-auto px-4 py-4 sm:py-6" role="main" aria-label="Search results">

<!-- User Query -->
<div class="flex items-start gap-3 mb-4" role="region" aria-label="Your question">
    <div class="flex-shrink-0 w-8 h-8 bg-slate-200 rounded-full flex items-center justify-center" aria-hidden="true">
        <svg class="w-4 h-4 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
        </svg>
    </div>
    <div class="pt-1">
        <p class="text-base sm:text-lg text-slate-800">{{ query }}</p>
    </div>
</div>

<!-- Temporal Context Badge (if applicable) -->
{% if temporal_context %}
<div class="mb-4">
    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
        {{ temporal_context }}
    </span>
</div>
{% endif %}

<!-- AI Response -->
<div class="flex items-start gap-3 mb-6" role="region" aria-label="AI response">
    <div class="flex-shrink-0 w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center" aria-hidden="true">
        <svg class="w-4 h-4 text-primary-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/>
        </svg>
    </div>
    <div class="flex-1">
        <p class="text-base sm:text-lg text-slate-800 leading-relaxed">{{ summary }}</p>
    </div>
</div>

<!-- Special Data Boxes (Fed SEP, Recession, CAPE, Polymarket) -->
{% if fed_sep_html %}
<div class="mb-6">{{ fed_sep_html | safe }}</div>
{% endif %}

{% if recession_html %}
<div class="mb-6">{{ recession_html | safe }}</div>
{% endif %}

{% if cape_html %}
<div class="mb-6">{{ cape_html | safe }}</div>
{% endif %}

{% if polymarket_html %}
<div class="mb-6">{{ polymarket_html | safe }}</div>
{% endif %}

<!-- Metrics Row -->
{% if charts %}
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4 mb-8">
    {% for chart in charts %}
    <div class="bg-white rounded-xl border border-slate-200 p-4 shadow-sm">
        <p class="text-xs font-medium text-slate-500 uppercase tracking-wide mb-1 leading-tight" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
            {% if chart.is_job_change %}Jobs/Month (3-mo avg){% else %}{{ chart.name }}{% endif %}
        </p>
        <p class="text-2xl font-bold {% if chart.is_job_change %}{{ 'text-emerald-600' if chart.latest >= 0 else 'text-red-600' }}{% else %}text-slate-900{% endif %}">
            {% if chart.is_job_change %}
                {{ "%+.0f"|format(chart.latest) }}K/mo
            {% elif chart.is_payems_level %}
                {{ "%.1f"|format(chart.latest / 1000) }}M
            {% elif 'Percent' in chart.unit or '%' in chart.unit %}
                {{ "%.1f"|format(chart.latest) }}%
            {% elif chart.latest > 1000000 %}
                {{ "%.1f"|format(chart.latest / 1000000) }}M
            {% elif chart.latest > 1000 %}
                {{ "%.0f"|format(chart.latest / 1000) }}K
            {% else %}
                {{ "%.1f"|format(chart.latest) }}
            {% endif %}
        </p>
        {# Secondary metric based on series type #}
        {% if chart.yoy_change is not none and chart.yoy_type %}
        <p class="text-sm mt-1 {% if chart.yoy_change >= 0 %}text-emerald-600{% else %}text-red-600{% endif %}">
            {% if chart.yoy_type == 'jobs' %}
                YoY: {{ "%+.1f"|format(chart.yoy_change / 1000) }}M
            {% elif chart.yoy_type == 'pp' %}
                {{ "%+.1f"|format(chart.yoy_change) }} pp YoY
            {% elif chart.yoy_type == 'percent' %}
                {{ "%+.1f"|format(chart.yoy_change) }}% YoY
            {% endif %}
        </p>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}

<!-- Charts -->
{% for chart in charts %}
<article class="bg-white rounded-2xl border border-slate-200 shadow-sm mb-6 overflow-hidden" aria-labelledby="chart-title-{{ chart.series_id }}">
    <!-- Chart Header -->
    <div class="px-4 sm:px-6 py-3 sm:py-4 border-b border-slate-100">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
            <div>
                <h3 id="chart-title-{{ chart.series_id }}" class="font-semibold text-slate-900 text-base sm:text-lg">
                    {% if chart.is_job_change %}Monthly Job Gains{% else %}{{ chart.name }}{% endif %}
                </h3>
                <p class="text-xs sm:text-sm text-slate-500">
                    {% if chart.is_job_change %}Thousands of jobs added/lost per month{% else %}{{ chart.unit }}{% endif %}
                </p>
            </div>
            <div class="sm:text-right">
                <p class="text-lg sm:text-xl font-bold {% if chart.is_job_change %}{{ 'text-emerald-600' if chart.latest >= 0 else 'text-red-600' }}{% else %}text-slate-900{% endif %}">
                    {% if chart.is_job_change %}
                        {{ "%+.0f"|format(chart.latest) }}K/mo <span class="text-sm font-normal text-slate-400">(3-mo avg)</span>
                    {% elif chart.is_payems_level %}
                        {{ "%.1f"|format(chart.latest / 1000) }}M
                    {% elif 'Percent' in chart.unit or '%' in chart.unit %}
                        {{ "%.2f"|format(chart.latest) }}%
                    {% elif chart.latest > 1000000 %}
                        {{ "%.2f"|format(chart.latest / 1000000) }}M
                    {% else %}
                        {{ "%.2f"|format(chart.latest) }}
                    {% endif %}
                </p>
                <p class="text-xs text-slate-400">{{ chart.latest_date }}</p>
            </div>
        </div>
    </div>

    <!-- Key Insights (Bullets) -->
    {% if chart.bullets %}
    <div class="px-4 sm:px-6 py-3 bg-slate-50 border-b border-slate-100">
        <ul class="text-sm text-slate-600 space-y-1" aria-label="Key insights">
            {% for bullet in chart.bullets[:2] %}
            <li class="flex items-start gap-2">
                <span class="text-slate-400 mt-1.5 text-xs" aria-hidden="true">-</span>
                <span class="leading-relaxed">{{ bullet }}</span>
            </li>
            {% endfor %}
        </ul>
    </div>
    {% endif %}

    <!-- Chart Container -->
    <div
        id="chart-{{ chart.series_id }}"
        class="chart-container px-2 sm:px-4 py-2"
        role="img"
        aria-label="Chart showing {% if chart.is_job_change %}monthly job gains{% else %}{{ chart.name }}{% endif %} over time. Latest value: {% if chart.is_job_change %}{{ '%+.0f'|format(chart.latest) }}K per month{% elif chart.is_payems_level %}{{ '%.1f'|format(chart.latest / 1000) }}M{% elif 'Percent' in chart.unit or '%' in chart.unit %}{{ '%.2f'|format(chart.latest) }}%{% else %}{{ '%.2f'|format(chart.latest) }}{% endif %} as of {{ chart.latest_date }}"
    ></div>

    <!-- Claude's Chart Description (if no bullets) -->
    {% if chart.description and not chart.bullets %}
    <div class="px-4 sm:px-6 py-4 border-t border-slate-100">
        <p class="text-sm text-slate-600 leading-relaxed">
            {{ chart.description }}
        </p>
    </div>
    {% endif %}

    <!-- Source with links -->
    <div class="px-4 sm:px-6 py-3 bg-slate-50 border-t border-slate-100">
        <p class="text-xs text-slate-400">
            {{ chart.name }}{% if chart.sa %}, Seasonally Adjusted{% endif %}.
            {% if chart.source == 'Robert Shiller, Yale University' %}
                Source: <a href="http://www.econ.yale.edu/~shiller/data.htm" target="_blank" class="text-primary-500 hover:underline">Robert Shiller, Yale University</a>
            {% elif chart.source == 'Zillow' %}
                Source: <a href="https://www.zillow.com/research/data/" target="_blank" class="text-primary-500 hover:underline">Zillow Research</a>
            {% elif chart.source == 'Alpha Vantage' %}
                Source: <a href="https://www.alphavantage.co/" target="_blank" class="text-primary-500 hover:underline">Alpha Vantage</a>
            {% elif chart.source == 'EIA' or 'Energy Information' in chart.source %}
                Source: <a href="https://www.eia.gov/" target="_blank" class="text-primary-500 hover:underline">U.S. Energy Information Administration</a>
            {% else %}
                Source: <a href="https://fred.stlouisfed.org/series/{{ chart.series_id }}" target="_blank" class="text-primary-500 hover:underline">{{ chart.source }}</a> via <a href="https://fred.stlouisfed.org/" target="_blank" class="text-primary-500 hover:underline">FRED</a>
            {% endif %}
        </p>
    </div>
</article>

<script>
(function() {
    const data = {{ chart | tojson }};

    // Build recession shapes
    const shapes = (data.recessions || []).map(r => ({
        type: 'rect',
        xref: 'x',
        yref: 'paper',
        x0: r.start,
        x1: r.end,
        y0: 0,
        y1: 1,
        fillcolor: 'rgba(148, 163, 184, 0.2)',
        line: { width: 0 },
        layer: 'below',
    }));

    // Color palette for multiple traces
    const colors = [
        '#3b82f6', // blue
        '#ef4444', // red
        '#10b981', // green
        '#f59e0b', // amber
        '#8b5cf6', // violet
        '#ec4899', // pink
    ];

    // Build traces - handle both single series and combined charts
    let traces = [];

    if (data.traces && Array.isArray(data.traces) && data.traces.length > 0) {
        // Combined chart with multiple traces
        traces = data.traces.map((trace, idx) => ({
            x: trace.dates || trace.x,
            y: trace.values || trace.y,
            type: 'scatter',
            mode: 'lines',
            name: trace.name || trace.series_id || `Series ${idx + 1}`,
            line: {
                color: colors[idx % colors.length],
                width: 2.5,
            },
            hovertemplate: `<b>${trace.name || trace.series_id || 'Value'}</b><br>%{x|%b %Y}: %{y:,.2f}<extra></extra>`,
        }));
    } else {
        // Single series chart
        traces = [{
            x: data.dates,
            y: data.values,
            type: 'scatter',
            mode: 'lines',
            fill: 'tozeroy',
            fillcolor: 'rgba(59, 130, 246, 0.08)',
            line: {
                color: '#3b82f6',
                width: 2.5,
            },
            hovertemplate: '<b>%{x|%b %Y}</b><br>%{y:,.2f}<extra></extra>',
        }];
    }

    // Layout options - show legend for combined charts
    const showLegend = traces.length > 1;

    Plotly.newPlot('chart-{{ chart.series_id }}', traces, {
        margin: { l: 50, r: 20, t: showLegend ? 30 : 10, b: 40 },
        height: showLegend ? 320 : 280,
        shapes: shapes,
        showlegend: showLegend,
        legend: {
            orientation: 'h',
            yanchor: 'bottom',
            y: 1.02,
            xanchor: 'center',
            x: 0.5,
            font: { size: 11, color: '#64748b' },
        },
        xaxis: {
            showgrid: false,
            tickformat: '%Y',
            tickfont: { size: 11, color: '#64748b' },
        },
        yaxis: {
            showgrid: true,
            gridcolor: '#f1f5f9',
            tickfont: { size: 11, color: '#64748b' },
            zeroline: false,
        },
        hoverlabel: {
            bgcolor: '#0f172a',
            font: { color: 'white', size: 13 },
            bordercolor: '#0f172a',
        },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent',
    }, {
        displayModeBar: false,
        responsive: true,
    });
})();
</script>
{% endfor %}

<!-- Follow-up Section -->
<div class="mt-8 pt-6 border-t border-slate-200">
    <p class="text-sm text-slate-500 mb-3">Continue exploring:</p>

    <!-- Claude's Suggestions -->
    <div class="flex flex-wrap gap-2 mb-4" role="group" aria-label="Suggested follow-up questions">
        {% for suggestion in suggestions %}
        <button
            hx-post="/search"
            hx-vals='{"query": {{ suggestion | tojson }}, "history": {{ history | tojson }}}'
            hx-target="#results"
            hx-swap="innerHTML"
            hx-indicator="#chat-loading"
            aria-label="Ask: {{ suggestion }}"
            class="px-3 sm:px-4 py-2 bg-white border border-slate-200 rounded-full text-sm font-medium text-slate-600
                   hover:border-primary-500 hover:text-primary-600 hover:bg-primary-50
                   focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2
                   transition-all duration-200 cursor-pointer"
        >
            {{ suggestion }}
        </button>
        {% endfor %}
    </div>

    <!-- Custom Follow-up Input -->
    <form
        hx-post="/search"
        hx-target="#results"
        hx-swap="innerHTML"
        hx-indicator="#chat-loading"
        class="relative"
        role="search"
        aria-label="Ask a follow-up question"
    >
        <input type="hidden" name="history" value="{{ history | e }}">
        <label for="followup-input" class="sr-only">Follow-up question</label>
        <input
            id="followup-input"
            type="text"
            name="query"
            placeholder="Ask a follow-up question..."
            autocomplete="off"
            required
            class="w-full px-4 sm:px-5 py-3 sm:py-4 pr-14 text-base bg-white border border-slate-300 rounded-2xl shadow-sm
                   focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-transparent
                   placeholder:text-slate-400 transition-shadow"
        >
        <button
            type="submit"
            aria-label="Submit follow-up question"
            class="absolute right-3 top-1/2 -translate-y-1/2 p-2 text-primary-600 hover:text-primary-700 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:ring-offset-2 rounded-lg"
        >
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M14 5l7 7m0 0l-7 7m7-7H3"/>
            </svg>
        </button>
    </form>

    <!-- Loading indicator -->
    <div id="chat-loading" class="htmx-indicator flex items-center justify-center py-4" role="status" aria-live="polite">
        <svg class="animate-spin w-6 h-6 text-primary-500" fill="none" viewBox="0 0 24 24" aria-hidden="true">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/>
            <path class="opacity-75" fill="currentColor"
                  d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"/>
        </svg>
        <span class="sr-only">Loading results...</span>
    </div>
</div>
</main>
